{% extends "base.html" %}

{% block title %}Balance Mensual - Panel de Administración{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='liquidaciones.css') }}">
{% endblock %}

{% block content %}
<div class="container" style="margin-top: 120px;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0">Balance Mensual</h3>
    </div>

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="anio" class="form-label">Filtrar por año:</label>
                    <select class="form-select" id="anio" name="anio">
                        {% for anio in anios_disponibles %}
                        <option value="{{ anio }}" {% if anio|string == selected_anio|string %}selected{% endif %}>{{ anio }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% if current_user.rol in ['master', 'admin'] %}
                <div class="col-md-3">
                    <label for="empresa_id" class="form-label">Filtrar por empresa:</label>
                    <select class="form-select" id="empresa_id" name="empresa_id">
                        <option value="">Todas las empresas</option>
                        {% for empresa in empresas %}
                        <option value="{{ empresa.id }}" {% if empresa.id|string == selected_empresa_id %}selected{% endif %}>
                            {{ empresa.nombre }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary">Filtrar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabla de balance mensual -->
    <div class="card">
        <div class="card-body">
            {% if balance_data %}
            <div class="table-responsive">
                <table class="table table-bordered table-hover text-white align-middle" id="tabla-balance-mensual">
                    <thead>
                        <tr>
                            <th>Mes</th>
                            <th>Ingresos por agentes</th>
                            <th>Ingresos externos</th>
                            <th>Egresos por comisión</th>
                            <th>Egresos por administración</th>
                            <th>Otros egresos</th>
                            <th>Ganancia/Pérdida</th>
                            <th>% Margen</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for mes in balance_data %}
                        <tr data-mes="{{ mes.numero }}">
                            <td>{{ mes.nombre }}</td>
                            <td class="ingresos-agentes">${{ "{:,.0f}".format(mes.ingresos_agentes or 0).replace(",", ".") }}</td>
                            <td>
                                <input type="text" class="form-control form-control-sm input-miles ingresos-externos" name="ingresos_externos_{{ mes.numero }}" value="{{ mes.ingresos_externos or 0 }}">
                            </td>
                            <td class="egresos-comision">${{ "{:,.0f}".format(mes.egresos_comision or 0).replace(",", ".") }}</td>
                            <td>
                                <input type="text" class="form-control form-control-sm input-miles egresos-administracion" name="egresos_administracion_{{ mes.numero }}" value="{{ mes.egresos_administracion or 0 }}">
                            </td>
                            <td>
                                <input type="text" class="form-control form-control-sm input-miles otros-egresos" name="otros_egresos_{{ mes.numero }}" value="{{ mes.otros_egresos or 0 }}">
                            </td>
                            <td class="ganancia-perdida">
                                ${{ "{:,.0f}".format((mes.ingresos_agentes or 0) + (mes.ingresos_externos or 0) - (mes.egresos_comision or 0) - (mes.egresos_administracion or 0) - (mes.otros_egresos or 0)).replace(",", ".") }}
                            </td>
                            <td class="margen-porcentaje">
                                {% set ingresos = (mes.ingresos_agentes or 0) + (mes.ingresos_externos or 0) %}
                                {% set egresos = (mes.egresos_comision or 0) + (mes.egresos_administracion or 0) + (mes.otros_egresos or 0) %}
                                {% if egresos > 0 and ingresos > 0 %}
                                    {{ (100 - ((egresos / ingresos) * 100))|round(1) }}%
                                {% else %}
                                    0.0%
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <script src="{{ url_for('static', filename='scripts/balance_mensual.js') }}"></script>
            </div>
            {% else %}
            <div class="alert alert-info">
                <h5>No hay datos disponibles</h5>
                <p>No se encontraron datos para el año seleccionado: <strong>{{ selected_anio }}</strong></p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Resumen estadístico eliminado: la variable 'totales' ya no existe en el backend. -->
</div>
{% endblock %}