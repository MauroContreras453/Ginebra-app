{% extends "base.html" %}

{% block title %}
{% if factura %}Editar Factura{% else %}Nueva Factura{% endif %} - Panel de Administración
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='nueva_factura.css') }}">
{% endblock %}

{% block content %}
<div class="container mt-5" style="max-width: 800px;">
  <h3 class="mb-4">{% if factura %}Editar Factura{% else %}Nueva Factura{% endif %}</h3>
  
  <form method="POST" action="{% if factura %}{{ url_for('editar_factura', id=factura.id) }}{% else %}{{ url_for('nueva_factura') }}{% endif %}">
    
    <div class="mb-3">
      <label for="empresa_id" class="form-label">Empresa</label>
      <select class="form-select form-select-sm" id="empresa_id" name="empresa_id" required>
        <option value="">Seleccionar empresa...</option>
        {% for empresa in empresas %}
        <option value="{{ empresa.id }}" {% if factura and factura.empresa_id == empresa.id %}selected{% endif %}>
          {{ empresa.nombre }}
        </option>
        {% endfor %}
      </select>
    </div>

    <div class="row">
      <div class="col-md-6 mb-3">
        <label for="mes" class="form-label">Mes</label>
        <input type="month" class="form-control form-control-sm" id="mes" name="mes" 
               value="{% if factura and factura.mes %}{{ factura.mes.strftime('%Y-%m') }}{% endif %}" required>
      </div>
      <div class="col-md-6 mb-3">
        <label for="monto" class="form-label">Monto</label>
        <input type="number" step="0.01" class="form-control form-control-sm" id="monto" name="monto" 
               value="{% if factura %}{{ factura.monto }}{% endif %}" required>
      </div>
    </div>

    <div class="row">
      <div class="col-md-6 mb-3">
        <label for="estado" class="form-label">Estado</label>
        <select class="form-select form-select-sm" id="estado" name="estado" required>
          <option value="No Pagado" {% if not factura or factura.estado == 'No Pagado' %}selected{% endif %}>No Pagado</option>
          <option value="Pagado" {% if factura and factura.estado == 'Pagado' %}selected{% endif %}>Pagado</option>
        </select>
      </div>
      <div class="col-md-6 mb-3">
        <label for="fecha_pago" class="form-label">Fecha de Pago</label>
        <input type="date" class="form-control form-control-sm" id="fecha_pago" name="fecha_pago"
               value="{% if factura and factura.fecha_pago %}{{ factura.fecha_pago.strftime('%Y-%m-%d') }}{% endif %}">
      </div>
    </div>

    <div class="mb-3">
      <label for="metodo_pago" class="form-label">Método de Pago</label>
      <input type="text" class="form-control form-control-sm" id="metodo_pago" name="metodo_pago" 
             value="{% if factura %}{{ factura.metodo_pago or '' }}{% endif %}" 
             placeholder="Transferencia, Efectivo, Cheque, etc.">
    </div>

    <div class="mb-3">
      <label for="observaciones" class="form-label">Observaciones</label>
      <textarea class="form-control form-control-sm" id="observaciones" name="observaciones" 
                rows="3" placeholder="Observaciones adicionales...">{% if factura %}{{ factura.observaciones or '' }}{% endif %}</textarea>
    </div>

    <div class="d-flex gap-2">
      <button type="submit" class="btn btn-custom">
        {% if factura %}Actualizar Factura{% else %}Crear Factura{% endif %}
      </button>
      <a href="{{ url_for('contabilidad_empresas') }}" class="btn btn-secondary">Cancelar</a>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Auto-habilitar fecha de pago cuando el estado es "Pagado"
document.getElementById('estado').addEventListener('change', function() {
  const fechaPago = document.getElementById('fecha_pago');
  if (this.value === 'Pagado' && !fechaPago.value) {
    fechaPago.value = new Date().toISOString().split('T')[0];
  }
});
</script>
{% endblock %}
