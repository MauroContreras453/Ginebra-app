{% extends "base.html" %}

{% block title %}Admin Reservas - Panel de AdministraciÃ³n{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='contabilidad_empresas.css') }}">
{% endblock %}

{% block content %}

<div class="container" style="margin-top: 120px;">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="mb-0">ðŸ“‹ GestiÃ³n de Reservas</h3>
  </div>

  <!-- Filtros -->
  <div class="card mb-4">
    <div class="card-body">
      <form method="GET" class="row g-3 align-items-end">
        {% if current_user.rol in ['master', 'admin'] %}
        <div class="col-md-2">
          <label for="empresa_id" class="form-label">Filtrar por empresa:</label>
          <select class="form-select" id="empresa_id" name="empresa_id">
            <option value="">Todas las empresas</option>
            {% for empresa in empresas %}
            <option value="{{ empresa.id }}" {% if empresa.id|string == selected_empresa_id %}selected{% endif %}>
              {{ empresa.nombre }}
            </option>
            {% endfor %}
          </select>
        </div>
        {% endif %}

        {% if current_user.rol in ['master', 'admin', 'controling'] %}
        <div class="col-md-2">
          <label for="usuario_id" class="form-label">Filtrar por usuario:</label>
          <select class="form-select" id="usuario_id" name="usuario_id">
            <option value="">Todos los usuarios</option>
            {% for usuario in usuarios %}
            <option value="{{ usuario.id }}" {% if usuario.id|string == selected_usuario_id %}selected{% endif %}>
              {{ usuario.nombre }} {{ usuario.apellidos }}
            </option>
            {% endfor %}
          </select>
        </div>
        {% endif %}

        <div class="col-md-2">
          <label for="fecha_venta" class="form-label">Mes venta:</label>
          <input type="month" class="form-select" id="fecha_venta" name="fecha_venta" 
                 value="{{ selected_fecha_venta or '' }}">
        </div>

        <div class="col-md-2">
          <label for="fecha_viaje" class="form-label">Mes viaje:</label>
          <input type="month" class="form-select" id="fecha_viaje" name="fecha_viaje" 
                 value="{{ selected_fecha_viaje or '' }}">
        </div>

        <div class="col-md-1">
          <button type="submit" class="btn btn-primary">Filtrar</button>
        </div>

        <div class="col-md-1">
          <a href="{{ url_for('exportar_reservas_admin', empresa_id=selected_empresa_id, usuario_id=selected_usuario_id, fecha_venta=selected_fecha_venta, fecha_viaje=selected_fecha_viaje) }}" class="btn btn-success w-100">ðŸ“¤ Excel</a>
        </div>

        <div class="col-md-2">
          <a href="{{ url_for('gestionar_reservas') }}" class="btn btn-custom w-100">Nueva Reserva</a>
        </div>
      </form>
    </div>
  </div>

  <!-- Tabla de reservas -->
  <div class="card">
    <div class="card-body">
      <style>
        .tabla-reservas-peq {
          font-size: 0.85rem;
        }
        .tabla-reservas-peq td.mail-col, .tabla-reservas-peq th.mail-col {
          padding-left: 0.375rem !important;
          padding-right: 0.375rem !important;
        }
      </style>
      {% if reservas.items %}
      <div class="table-responsive">
        <table class="table table-bordered table-hover text-white align-middle w-100 tabla-reservas-peq">
          <thead>
            <tr>
              <th>Usuario</th>
              <th>Fecha venta</th>
              <th>Fecha viaje</th>
              <th>Producto</th>
              <th>Nombre pasajero</th>
              <th>TelÃ©fono</th>
              <th class="mail-col">Mail</th>
              <th>Localizadores</th>
              <th>Destino</th>
              <th>Estado</th>
              <th class="text-center">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for reserva in reservas.items %}
            <tr>
              <td>{{ reserva.usuario.username if reserva.usuario else 'Sin usuario' }}</td>
              <td>{{ reserva.fecha_venta.strftime('%Y-%m-%d') if reserva.fecha_venta else '-' }}</td>
              <td>{{ reserva.fecha_viaje.strftime('%Y-%m-%d') if reserva.fecha_viaje else '-' }}</td>
              <td>{{ reserva.producto or '-' }}</td>
              <td>{{ reserva.nombre_pasajero or '-' }}</td>
              <td>{{ reserva.telefono_pasajero or '-' }}</td>
              <td class="mail-col">{{ reserva.mail_pasajero or '-' }}</td>
              <td>{{ reserva.localizadores or '-' }}</td>
              <td>{{ reserva.destino or '-' }}</td>
              <td>
                {% if reserva.estado_pago == 'Pagado' and reserva.venta_cobrada == 'Cobrada' and reserva.venta_emitida == 'Emitida' %}
                  <span class="badge bg-success">OK</span>
                {% else %}
                  <span class="badge bg-warning text-dark">Pendiente</span>
                {% endif %}
              </td>
              <td class="text-center">
                <div class="d-inline-flex gap-2">
                  {% if reserva.comprobante_venta %}
                    <a href="{{ url_for('descargar_comprobante', reserva_id=reserva.id) }}" target="_blank" title="Ver PDF" class="icon-action text-info">
                      <i class="fa-regular fa-file-pdf"></i>
                    </a>
                  {% endif %}
                  {% if current_user.rol in ['admin', 'master'] or reserva.usuario_id == current_user.id %}
                    <a href="{{ url_for('gestionar_reservas', editar=reserva.id) }}" class="icon-action text-warning" title="Editar">
                      <i class="fa-regular fa-pen-to-square"></i>
                    </a>
                  {% endif %}
                  <form action="{{ url_for('eliminar_reserva', id=reserva.id) }}" method="post" class="d-inline" onsubmit="return confirm('Â¿Eliminar esta reserva?')" style="display:inline;">
                    <button type="submit" class="icon-action text-danger" title="Eliminar">
                      <i class="fa-solid fa-trash"></i>
                    </button>
                  </form>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- PaginaciÃ³n -->
      {% if reservas.pages > 1 %}
      <nav aria-label="Page navigation" class="mt-3">
        <ul class="pagination justify-content-center">
          {% if reservas.has_prev %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('admin_reservas', page=reservas.prev_num, empresa_id=selected_empresa_id, usuario_id=selected_usuario_id, fecha_venta=selected_fecha_venta, fecha_viaje=selected_fecha_viaje) }}">&laquo;</a>
          </li>
          {% endif %}
          {% for page_num in reservas.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
            {% if page_num %}
              <li class="page-item {% if reservas.page == page_num %}active{% endif %}">
                <a class="page-link" href="{{ url_for('admin_reservas', page=page_num, empresa_id=selected_empresa_id, usuario_id=selected_usuario_id, fecha_venta=selected_fecha_venta, fecha_viaje=selected_fecha_viaje) }}">{{ page_num }}</a>
              </li>
            {% else %}
              <li class="page-item disabled"><a class="page-link" href="#">...</a></li>
            {% endif %}
          {% endfor %}
          {% if reservas.has_next %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('admin_reservas', page=reservas.next_num, empresa_id=selected_empresa_id, usuario_id=selected_usuario_id, fecha_venta=selected_fecha_venta, fecha_viaje=selected_fecha_viaje) }}">&raquo;</a>
          </li>
          {% endif %}
        </ul>
      </nav>
      {% endif %}

      {% else %}
      <div class="text-center py-5">
        <p class="mb-0">No hay reservas que coincidan con los filtros seleccionados.</p>
        <a href="{{ url_for('gestionar_reservas') }}" class="btn btn-custom mt-3">Crear primera reserva</a>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}