{% extends "base.html" %}

{% block title %}Admin Reservas - Panel de AdministraciÃ³n{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='empresas_asociadas.css') }}">
{% endblock %}

{% block content %}
  <div class="container" style="margin-top: 120px;">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="mb-3">ğŸ“‹ Todas las Reservas - Panel Admin</h3>
        {% if current_user.rol in ['admin', 'master'] %}
          <div class="d-flex gap-2">
            <a href="{{ url_for('gestionar_reservas') }}" class="btn btn-custom">Nueva Reserva</a>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Formulario de bÃºsqueda -->
    <form method="get" class="mb-4">
      <div class="input-group">
        <input type="text" class="form-control" name="search" placeholder="Buscar reservas..." value="{{ search_query or '' }}">
        <button class="btn btn-custom" type="submit">Buscar</button>
        {% if search_query %}
          <a href="{{ url_for('admin_reservas') }}" class="btn btn-outline-light">Limpiar</a>
        {% endif %}
      </div>
    </form>

    <!-- Tabla de reservas -->
    {% if current_user.rol in ['admin', 'master'] %}
    <table class="table table-bordered table-hover text-white align-middle">
      <thead>
        <tr>
          <th>Usuario</th>
          <th>Fecha venta</th>
          <th>Fecha viaje</th>
          <th>Producto</th>
          <th>Nombre pasajero</th>
          <th>TelÃ©fono</th>
          <th>Mail</th>
          <th>Localizadores</th>
          <th>Destino</th>
          <th>Estado</th>
          <th class="text-center">Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for reserva in reservas %}
        <tr>
          <td>{{ reserva.usuario.username }}</td>
          <td>{{ reserva.fecha_venta }}</td>
          <td>{{ reserva.fecha_viaje }}</td>
          <td>{{ reserva.producto }}</td>
          <td>{{ reserva.nombre_pasajero }}</td>
          <td>{{ reserva.telefono_pasajero }}</td>
          <td>{{ reserva.mail_pasajero }}</td>
          <td>{{ reserva.localizadores }}</td>
          <td>{{ reserva.destino }}</td>
          <td>
            {% if reserva.estado_pago == 'Pagado' and reserva.venta_cobrada == 'Cobrada' and reserva.venta_emitida == 'Emitida' %}
              <span class="badge bg-success">ok</span>
            {% else %}
              <span class="badge bg-danger">not ok</span>
            {% endif %}
          </td>
          <td class="text-center">
            <div class="d-inline-flex gap-2">
              {% if reserva.comprobante_venta %}
                <a href="{{ url_for('descargar_comprobante', reserva_id=reserva.id) }}" target="_blank" title="Ver PDF" class="btn btn-sm btn-info">PDF</a>
              {% endif %}
              {% if current_user.rol in ['admin', 'master'] or reserva.usuario_id == current_user.id %}
                <a href="{{ url_for('gestionar_reservas', editar=reserva.id) }}" class="btn btn-sm btn-warning">Editar</a>
              {% endif %}
              {% if current_user.rol in ['admin', 'master'] %}
                <form action="{{ url_for('eliminar_reserva', id=reserva.id) }}" method="post" class="d-inline" onsubmit="return confirm('Â¿Eliminar esta reserva?')">
                  <button type="submit" class="btn btn-sm btn-danger">Eliminar</button>
                </form>
              {% endif %}
            </div>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="11" class="text-center">No hay reservas registradas.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% endif %}

    <!-- PaginaciÃ³n -->
    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-center">
        {% if pagination.has_prev %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('admin_reservas', page=pagination.prev_num, search=search_query) }}">&laquo;</a>
        </li>
        {% endif %}
        {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
          {% if page_num %}
            <li class="page-item {% if pagination.page == page_num %}active{% endif %}">
              <a class="page-link" href="{{ url_for('admin_reservas', page=page_num, search=search_query) }}">{{ page_num }}</a>
            </li>
          {% else %}
            <li class="page-item disabled"><a class="page-link" href="#">...</a></li>
          {% endif %}
        {% endfor %}
        {% if pagination.has_next %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('admin_reservas', page=pagination.next_num, search=search_query) }}">&raquo;</a>
        </li>
        {% endif %}
      </ul>
    </nav>
  </div>
</div>
{% endblock %}